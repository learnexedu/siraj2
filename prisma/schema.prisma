// config
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// enums
enum UserRole {
  supervisor
  postgraduate
  undergraduate
}

enum Gender {
  MALE
  FEMALE
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
  WAITLISTED
}

enum SemesterType {
  TERM1
  TERM2
  SUMMER
  CUSTOM
}

enum CourseType {
  MANDATORY
  OPTIONAL
}

enum DepartmentType {
  CIVIL
  ARCHITECTURE
  ELECTRICAL
  MECHANICAL
}

enum Degree {
  DIPLOMA
  BACHELOR
  MASTER
  DOCTORATE
}

// models
// system
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  phoneVerified DateTime? @map("phone_verified")
  password      String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  role          UserRole

  //            @relations
  accounts Account[]
  students Student[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model VerificationToken {
  id     String   @id @default(cuid())
  email  String
  token  String   @unique
  otp    String
  expire DateTime

  @@unique([email, token])
  @@map("verification_tokens")
}

model Setting {
  id        String   @id @default(cuid())
  value     Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  category  String
  subKey    String   @map("sub_key")

  @@unique([category, subKey])
  @@map("settings")
}

model Image {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  key        String
  url        String?
  title      String?

  @@map("images")
}

model File {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  key        String
  url        String?
  title      String?

  @@map("files")
}

// acadmic
model Department {
  id   String         @id @default(cuid())
  name Json
  type DepartmentType

  // @ relations
  programs Program[]
  courses  Course[]
  majors   Major[]
  students Student[]

  @@map("departments")
}

model Major {
  id          String @id @default(cuid())
  name        String
  description String

  // @ relations
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  students     Student[]

  @@map("majors")
}

model Semester {
  id             String       @id @default(cuid())
  name           String
  startDate      DateTime     @map("start_date")
  endDate        DateTime     @map("end_date")
  examStartDate  DateTime     @map("exam_start_date")
  examEndDate    DateTime     @map("exam_end_date")
  withdrawalDate DateTime     @map("withdrawal_date")
  type           SemesterType

  // @ relations
  program  Program[]
  grades   Grade[]
  lectures Lecture[]
  sections Section[]

  @@map("semesters")
}

model Program {
  id         String @id @default(cuid())
  name       Json
  overview   Json
  objectives Json

  mandatory      Int
  optional       Int
  degree         Degree
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  // @ relation
  departmentId   String          @map("department_id")
  department     Department      @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  programCourses ProgramCourse[]
  progress       Progress[]

  semester    Semester?    @relation(fields: [semesterId], references: [id])
  semesterId  String?      @map("semester_id")
  students    Student[]
  enrollments Enrollment[]

  @@map("programs")
}

model Course {
  id      String @id @default(cuid())
  code    String
  title   Json
  credits Int

  // credit breakdown
  written   Int
  work      Int
  practical Int
  oral      Int

  // @ relations
  departmentId String     @map("department_id")
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  programCourses ProgramCourse[]
  prerequisites  Prerequisite[]  @relation("CoursePrereqs")
  requiredFor    Prerequisite[]  @relation("CourseRequiredFor")
  grades         Grade[]
  sections       Section[]
  lectures       Lecture[]

  @@map("courses")
}

model ProgramCourse {
  id String @id @default(cuid())

  // @ relations 
  programId String  @map("program_id")
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  courseId String @map("course_id")
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  type CourseType

  @@map("program_courses")
}

model Progress {
  id        String   @id @default(cuid())
  total     Int
  earned    Int      @default(0)
  remaining Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  // @ relations
  programId String  @map("program_id")
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  studentId String  @map("student_id")
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, programId])
  @@map("progresses")
}

model Grade {
  id          String  @id @default(cuid())
  grade       String
  //   credits earned
  credits     Int
  gradePoints Decimal @map("grade_points") @db.Decimal(4, 2)

  // @ relations
  studentId String  @map("student_id")
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  courseId String @map("course_id")
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  semesterId String   @map("semester_id")
  semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId, semesterId])
  @@map("grades")
}

model Student {
  id          String   @id @default(cuid())
  firstName   String   @map("first_name")
  lastName    String   @map("last_name")
  fullName    String   @map("full_name")
  phone       String   @unique
  image       String
  nationality String
  nationalId  String   @unique @map("national_id")
  address     String
  country     String
  state       String
  dob         String
  gender      Gender
  degree      Degree
  createdAt   DateTime @default(now()) @map("created_at")

  // @ relations
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  facultyId String?  @map("faculty_id")
  faculty   Faculty? @relation(fields: [facultyId], references: [id])

  majorId String? @map("major_id")
  major   Major?  @relation(fields: [majorId], references: [id])

  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])

  programId String?  @map("program_id")
  program   Program? @relation(fields: [programId], references: [id])

  enrollments Enrollment[]
  grades      Grade[]
  progresses  Progress[]
  attandances Attandance[]

  @@map("students")
}

model Faculty {
  id          String  @id @default(cuid())
  name        String
  code        String  @unique
  description String
  location    String
  country     String
  state       String?

  // @ relations
  students Student[]

  @@map("faculties")
}

model Prerequisite {
  id String @id @default(cuid())

  // @ relations 
  courseId       String @map("course_id")
  course         Course @relation("CoursePrereqs", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisiteId String @map("prerequisite_id")
  prerequisite   Course @relation("CourseRequiredFor", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@map("prerequisites")
}

model Enrollment {
  id     String           @id @default(cuid())
  status EnrollmentStatus

  // @ relations
  programId String  @map("program_id")
  program   Program @relation(fields: [programId], references: [id])
  studentId String  @map("student_id")
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, programId])
  @@map("enrollments")
}

model Lecture {
  id       String @id @default(cuid())
  number   Int    @default(autoincrement())
  date     String
  time     String
  room     String
  location String

  // @ relations 
  attandance Attandance[]
  // instructorId Int?
  // instructor   Doctor? @relation(fields: [instructorId], references: [id])
  courseId   String       @map("course_id")
  course     Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  semesterId String   @map("semester_id")
  semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)

  @@map("lectures")
}

model Section {
  id          String @id @default(cuid())
  // instructorId BigInt?
  // instructor   FacultyMember? @relation(fields: [instructorId], references: [id])
  sectionCode String @map("section_code")
  date        String
  time        String
  room        String

  // @ relations 
  courseId String @map("course_id")
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  semesterId String   @map("semester_id")
  semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)

  @@map("sections")
}

model Attandance {
  id   String  @id @default(cuid())
  date String?
  time String?
  room String?

  // @ relations 
  studentId String  @map("student_id")
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // lecture or section
  lecture   Lecture? @relation(fields: [lectureId], references: [id])
  lectureId String?  @map("lecture_id")

  @@map("attandances")
}
